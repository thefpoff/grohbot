<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

	<head>

		<!-- Required meta tags for Bootstrap CSS -->
	    <meta charset="utf-8">
	    <meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- Bootstrap CSS -->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
		<!-- JavaScript Bundle with Popper -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
		<!-- d3 for .csv function -->
		<script src="https://d3js.org/d3.v6.min.js"></script>
		<!-- Chart js --> 
		<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js" integrity="sha256-t9UJPrESBeG2ojKTIcFLPGF7nHi2vEc7f5A2KpH/UBU=" crossorigin="anonymous"></script>
		<!-- Slider for Bootstrap JS -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/bootstrap-slider.min.js" integrity="sha512-f0VlzJbcEB6KiW8ZVtL+5HWPDyW1+nJEjguZ5IVnSQkvZbwBt2RfCBY0CBO1PsMAqxxrG4Di6TfsCPP3ZRwKpA==" crossorigin="anonymous"></script>
		<!-- Slider for Bootstrap CSS -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/css/bootstrap-slider.min.css" integrity="sha512-3q8fi8M0VS+X/3n64Ndpp6Bit7oXSiyCnzmlx6IDBLGlY5euFySyJ46RUlqIVs0DPCGOypqP8IRk/EyPvU28mQ==" crossorigin="anonymous" />

		<link rel="shortcut icon" href="static/favicon.ico">
		<link rel="stylesheet" href='{{ url_for('static',    filename='style.css') }}' />
		<style>
			.chart{
			vertical-align: middle;
			width: 100%;
			margin: 0 auto;
			position: relative;
			display: inline-block;

			}
			p {
			text-align: center;
			font-family:'Verdana', sans-serif;
			font-size: 10px;
			}

			canvas{
			height: 100%;
			}
		</style>
		
		<title>GROHBOT LIVE</title>
	</head>

	<body>

		<div class="container-fluid">

			<div class = "row">

				<div class="col-sm-7 imgdiv">

					<a href="/?action=refresh">
						<img class="camshot rounded mx-auto d-block" src="static/grohbot.jpg?{{ imgstamp }}"/>
					</a>

				
				</div>

				<div class="col-sm-5 controlsdiv">

						{% for name, device in devices.items() %}
						<div class = "row devicediv" >
							<div class="devicetext text-end col-sm-2 col-sm-6">
								{{ device.name }}
							</div>

							<div class="btncol col-sm-2 col-sm-6">

								{% if device.state == 0 %}
									<a class="devicebtn btn-sm btn-secondary" href="/?action={{ device.page }}off">OFF</a> <a class="devicebtn btn-sm btn-dark" href="/?action={{ device.page }}on">ON</a>
								{% else %}
									<a class="devicebtn btn-sm btn-dark" href="/?action={{ device.page }}off">OFF</a> <a class="devicebtn btn-sm btn-warning" href="/?action={{ device.page }}on">ON</a>
								{% endif %}
							</div>
						</div>
						{% endfor %}


						<div class="row">
							<div class="col-sm-5 col-sm-12">
								<label for="lightsOnRange" class="form-label">Lights On/Off</label>
							</div>
						</div>

						<div class="row">
							<div class="col-sm-5 col-sm-12">
								<input id="lightsOnRange" type="text" class="lightsinput" value="" data-slider-min="0" data-slider-max="23" data-slider-step="1" data-slider-value="[{{ configdata.hour_lights_on }},{{ configdata.hour_lights_off }}]"/>
							</div>
						</div>

						<div class="row">	
							<div class="col-sm-5 col-sm-12">
								<label for="tempsRange" class="form-label">Low Temp / High Temp</label>
							</div>
						</div>

						<div class="row">	
							<div class="col-sm-5 col-sm-12">
								<input id="tempsRange" type="text" class="tempsinput" value="" data-slider-min="0" data-slider-max="110" data-slider-step="1" data-slider-value="[{{ configdata.low_temp_trigger }},{{ configdata.high_temp_trigger }}]"/>
							</div>
						</div>

						<div class="row">
							<div class="col-sm-5 col-sm-12">
								<label for="humidRange" class="form-label">High Humidity</label>
							</div>
						</div>

						<div class="row">
							<div class="col-sm-5 col-sm-12">
								<input id="humidRange" type="text" class="humidinput" value="" data-slider-min="0" data-slider-max="100" data-slider-step="1" data-slider-value="{{ configdata.high_humid_trigger }}"/>
							</div>
						</div>

				</div>
			
			</div>

			<div class="row">

				<div class="col-12">
					<div class="panel-content text-center  histchart">
						<canvas id="myLineChart" class="chart" height="264" width="900"></canvas>
					</div>
				</div>
			
			</div>
			
		</div>

	<script>
			
			window.onload = (event) => {
    			
				console.log('The page has fully loaded');
				// If URL is an action page, reset URL to home so we dont get refresh errors
				var currentPathname = window.location.pathname;
				if (currentPathname != "") {
					ChangeUrl("GROHBOT LIVE", "http://10.0.0.199:5000/")
				}
				
				var lightsSlider = new Slider('#lightsOnRange', {
					
					formatter: function(value) {
						return 'Current value: ' + value;
					}
				});
				var lightsSliderValue = lightsSlider.getValue();
				//lightsSlider.setValue(12);

				var tempsSlider = new Slider('#tempsRange', {
					formatter: function(value) {
						return 'Current value: ' + value;
					}
				});

				var humidSlider = new Slider('#humidRange', {
					formatter: function(value) {
						return 'Current value: ' + value;
					}
				});

				// get file and set up chart 
				d3.csv("static/csv/lastdht.csv").then(makeChart);
			
			};
			
			
			function makeChart(dhtdata) {
				
				var temps = dhtdata.map(function(d) {
    				return d.Temp;
  				});
  				var humid = dhtdata.map(function(d) {
    				return d.Humidity;
  				});
				var timelables = dhtdata.map(function(d) {
					return d.Datetime.substring(0,5);
				});
				// Data
				var data = {
				labels: timelables,
				datasets: [{
					label: "Temperature(F)",
					backgroundColor: "rgba(75,192,192,0.4)",
					data: temps
				}, {
					label: "Humidity",
					backgroundColor: "rgba(187,80,17,0.4)",
					data: humid
				}]
				};


				// Global + Custom Chart Config Options

				var options = {
				bezierCurve: false,
				animation: true,
				animationEasing: "easeOutQuart",
				showScale: false,
				tooltipEvents: ["mousemove", "touchstart", "touchmove"],
				tooltipCornerRadius: 3,
				pointDot : true,
				pointDotRadius : 4,
				datasetFill : true,
				scaleShowLine : true,
				animationEasing : "easeOutBounce",
				animateRotate : true,
				animateScale : true,
				responsive: true
				};


				// Load Chart

				var ctx1 = document.getElementById("myLineChart").getContext("2d");
				var myLineChart = new Chart(ctx1, {
					type: 'line',
					data,
					options
				});
			}
			
			function ChangeUrl(title, url) {
				if (typeof (history.pushState) != "undefined") {
					var obj = { Title: title, Url: url };
					history.pushState(obj, obj.Title, obj.Url);
				} else {
					alert("Browser does not support HTML5.");
				}
			}
		</script>
	</body>
</html>
